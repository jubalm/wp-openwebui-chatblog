# Gemini Project Context: IONOS MKS PoC (wp-openwebui)

This document provides context for the AI assistant about the project. It is based on the Product Requirements Document (`docs/product-requirements.md`).

## 1. Project Overview

This is a Proof of Concept (PoC) project to deploy and integrate a multi-tenant application stack on IONOS Managed Kubernetes (MKS). The stack consists of:
- A single **OpenWebUI** instance (a web UI for LLMs).
- A single **Authentik** instance (for SSO).
- Multiple isolated **WordPress** instances (one per tenant).

The project uses IONOS Managed Databases (PostgreSQL for Authentik, MariaDB for each WordPress tenant) and Terraform for infrastructure provisioning. A key feature is the **ModelContextProtocol (MCP)**, a custom integration enabling OpenWebUI to communicate with the WordPress instances to draft blog posts.

## 2. Project Structure

### 2.1 Core Technologies

- **Cloud Platform:** IONOS Cloud
  - IONOS Managed Kubernetes (MKS) in `de/txl`
  - IONOS Managed MariaDB & PostgreSQL
  - IONOS Object Storage (for Terraform state)
  - IONOS OpenAI-compatible LLM Endpoint
- **Infrastructure as Code:** Terraform (`/terraform`)
- **Container Orchestration:** Kubernetes
- **Applications:**
  - **Authentik:** SSO provider.
  - **WordPress:** Custom Docker image including the `wordpress-mcp` and OIDC plugins.
  - **OpenWebUI:** Web UI for LLMs.
- **CI/CD & Secrets:** GitHub Actions (`.github/workflows`), with a unified `plan -> approve -> apply` workflow.
- **Key Protocols:** OIDC (SSO), ModelContextProtocol (MCP), OpenAI API.

### 2.2 Application Deployment (Helm Charts)

The `/charts` directory contains Helm charts for deploying the applications:
- `charts/authentik`: Helm chart for Authentik.
- `charts/openwebui`: Helm chart for OpenWebUI.
- `charts/wordpress`: Helm chart for WordPress, used for deploying multiple tenant instances.

### 2.3 Custom WordPress Docker Image

The `/docker/wordpress` directory contains the Dockerfile and associated scripts for building the custom WordPress Docker image. This image includes:
- The `wordpress-mcp` plugin for ModelContextProtocol integration.
- The OIDC plugin for Single Sign-On with Authentik.

### 2.4 Architecture Summary

- **Infrastructure:** All IONOS cloud resources (MKS cluster, node pools, databases) are defined and managed by Terraform scripts located in the `/terraform` directory. The Terraform state is stored in IONOS Object Storage.
- **Kubernetes Layout:**
  - `admin-apps` namespace: Hosts the shared Authentik and OpenWebUI deployments.
  - `wordpress-tenant-<name>` namespaces: Each WordPress tenant is deployed in its own isolated namespace.
- **Application Integration:**
  - **Authentication:** Authentik acts as the central OIDC SSO provider for both OpenWebUI and all WordPress instances.
  - **Database:** Authentik uses a managed PostgreSQL instance. Each WordPress instance uses its own dedicated managed MariaDB instance.
  - **LLM & Content:** OpenWebUI connects to an IONOS-provided OpenAI-compatible LLM endpoint. It then uses the ModelContextProtocol (MCP) to send generated content as draft posts to the appropriate WordPress tenant.
- **Networking:**
  - Internal communication uses standard Kubernetes services and DNS (e.g., `openwebui` to `wordpress-mcp-service.wordpress-tenant-foo.svc.cluster.local`).
  - External access is provided via IP-based Kubernetes Ingress rules. No custom domains or TLS are in scope for this PoC.
- **Secrets Management:** Sensitive data (API tokens, database credentials) are managed securely. Per-tenant WordPress database passwords are now automatically generated using Terraform's `random` provider, ensuring unique and strong credentials for each tenant. Other secrets are stored as GitHub Actions secrets and injected into the cluster as Kubernetes Secrets during the CI/CD workflow.

## 4. Key Project Goals

- Provision the entire infrastructure using Terraform.
- Deploy and configure the full application stack (Authentik, OpenWebUI, multiple WordPress tenants) on MKS.
- Implement end-to-end SSO using Authentik.
- Demonstrate OpenWebUI interacting with the IONOS LLM.
- Demonstrate OpenWebUI creating draft posts in any WordPress tenant via the MCP integration.
- Automate deployment and secret management using GitHub Actions.

## 5. Connecting to the Kubernetes Cluster

To connect to the MKS cluster, you need to use the `kubeconfig` file generated by the `infrastructure` Terraform module.

1.  **Navigate to the `infrastructure` directory:**
    ```bash
    cd terraform/infrastructure
    ```

2.  **Extract the `kubeconfig`:**
    ```bash
    terraform output -raw kubeconfig > kubeconfig.yaml
    ```

3.  **Use the `kubeconfig` with `kubectl`:**
    You can now use the generated `kubeconfig.yaml` file to interact with your cluster. For example, to get the pods in the `admin-apps` namespace, you would run:
    ```bash
    kubectl --kubeconfig=kubeconfig.yaml get pods -n admin-apps
    ```

## 6. Debugging Helm Releases in Terraform

When debugging `helm_release` resources in Terraform that are failing to deploy pods (e.g., due to `ImagePullBackOff`), temporarily set `wait = false` on the `helm_release` resource. This prevents `terraform apply` from hanging for the full timeout, allowing for quicker `kubectl` inspection of the failing pods.